<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Ethara AI × ARC</title>
        <style>
            @import url("https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Press+Start+2P&family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap");

            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            :root {
                --bg: #0e1117;
                --panel: #161b22;
                --panel2: #1c2129;
                --border: #30363d;
                --text: #c9d1d9;
                --text-dim: #8b949e;
                --text-bright: #f0f6fc;
                --accent: #58a6ff;
                --green: #3fb950;
                --green-dim: #238636;
                --purple: #bc8cff;
                --purple-dim: rgba(188, 140, 255, 0.15);
                --orange: #f0883e;
                --red: #f85149;
                --mono: "Share Tech Mono", "Courier New", monospace;
                --pixel: "Press Start 2P", monospace;
                --sans: "Inter", sans-serif;
                --code: "JetBrains Mono", monospace;
            }

            html,
            body {
                height: 100%;
                overflow: hidden;
                background: var(--bg);
                color: var(--text);
                font-family: var(--mono);
            }

            /* ═══ TOP BAR ═══ */
            #topbar {
                display: flex;
                align-items: center;
                gap: 16px;
                padding: 10px 24px;
                background: var(--panel);
                border-bottom: 1px solid var(--border);
                height: 48px;
                flex-shrink: 0;
                z-index: 100;
            }
            .logo {
                font-family: var(--pixel);
                font-size: 12px;
                color: var(--accent);
                white-space: nowrap;
                text-decoration: none;
                cursor: pointer;
            }
            .sep {
                width: 1px;
                height: 20px;
                background: var(--border);
            }
            .tagline {
                font-size: 12px;
                color: var(--text-dim);
            }
            .spacer {
                flex: 1;
            }

            /* ═══ LAYOUT ═══ */
            #app {
                display: flex;
                flex-direction: column;
                height: 100vh;
            }
            #content {
                flex: 1;
                display: flex;
                overflow: hidden;
                min-height: 0;
            }

            /* ═══ HALF PANELS ═══ */
            .half {
                flex: 1;
                display: flex;
                flex-direction: column;
                min-width: 0;
                overflow: hidden;
            }
            .half:first-child {
                border-right: 1px solid var(--border);
            }

            /* ── Section Header ── */
            .section-head {
                padding: 20px 24px 16px;
                border-bottom: 1px solid var(--border);
                flex-shrink: 0;
                display: flex;
                flex-direction: column;
                gap: 12px;
            }
            .section-title-row {
                display: flex;
                align-items: center;
                gap: 12px;
            }
            .section-badge {
                font-family: var(--pixel);
                font-size: 9px;
                letter-spacing: 1px;
                padding: 4px 10px;
                border-radius: 3px;
                white-space: nowrap;
            }
            .badge-purple {
                background: var(--purple-dim);
                color: var(--purple);
                border: 1px solid rgba(188, 140, 255, 0.3);
            }
            .badge-green {
                background: rgba(63, 185, 80, 0.12);
                color: var(--green);
                border: 1px solid rgba(63, 185, 80, 0.3);
            }
            .section-title {
                font-family: var(--pixel);
                font-size: 14px;
                color: var(--text-bright);
            }
            .section-count {
                font-family: var(--code);
                font-size: 11px;
                color: var(--text-dim);
                margin-left: auto;
            }
            .section-desc {
                font-size: 12px;
                color: var(--text-dim);
                line-height: 1.5;
            }

            /* ── Controls row (search + upload) ── */
            .section-controls {
                display: flex;
                align-items: center;
                gap: 10px;
            }
            .search-box {
                flex: 1;
                padding: 8px 12px;
                font-family: var(--code);
                font-size: 12px;
                color: var(--text);
                background: var(--bg);
                border: 1px solid var(--border);
                border-radius: 4px;
                outline: none;
                transition: border-color 0.2s;
            }
            .search-box:focus {
                border-color: var(--accent);
            }
            .search-box::placeholder {
                color: #444;
            }

            .upload-btn {
                font-family: var(--code);
                font-size: 11px;
                padding: 8px 14px;
                background: transparent;
                border: 1px dashed var(--border);
                color: var(--text-dim);
                border-radius: 4px;
                cursor: pointer;
                transition: all 0.15s;
                white-space: nowrap;
                display: inline-flex;
                align-items: center;
                gap: 6px;
            }
            .upload-btn:hover {
                border-color: var(--accent);
                color: var(--text-bright);
                background: rgba(88, 166, 255, 0.05);
            }
            .upload-btn input[type="file"] {
                display: none;
            }

            /* ── Category tabs (AGI-2 only) ── */
            .cat-tabs {
                display: flex;
                gap: 0;
                border-bottom: 1px solid var(--border);
                flex-shrink: 0;
                padding: 0 24px;
            }
            .cat-tab {
                font-family: var(--code);
                font-size: 11px;
                color: #555;
                background: none;
                border: none;
                border-bottom: 2px solid transparent;
                padding: 10px 16px 8px;
                cursor: pointer;
                transition: all 0.15s;
                display: flex;
                align-items: center;
                gap: 6px;
            }
            .cat-tab:hover {
                color: #999;
            }
            .cat-tab.active {
                color: var(--purple);
                border-bottom-color: var(--purple);
            }
            .cat-tab .ct-count {
                font-size: 9px;
                background: rgba(255, 255, 255, 0.06);
                color: #555;
                padding: 1px 6px;
                border-radius: 8px;
            }
            .cat-tab.active .ct-count {
                background: var(--purple-dim);
                color: var(--purple);
            }

            /* ── Scrollable card area ── */
            .card-scroll {
                flex: 1;
                overflow-y: auto;
                overflow-x: hidden;
                padding: 20px 24px 30px;
            }
            .card-scroll::-webkit-scrollbar {
                width: 6px;
            }
            .card-scroll::-webkit-scrollbar-track {
                background: transparent;
            }
            .card-scroll::-webkit-scrollbar-thumb {
                background: #2a2e36;
                border-radius: 3px;
            }
            .card-scroll::-webkit-scrollbar-thumb:hover {
                background: #3a3e46;
            }

            /* ── Card Grid ── */
            .card-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
                gap: 16px;
            }

            /* ── Game / Task Card (shared) ── */
            .g-card {
                background: var(--panel);
                border: 1px solid var(--border);
                cursor: pointer;
                transition: all 0.2s;
                overflow: hidden;
                display: flex;
                flex-direction: column;
                position: relative;
            }
            .g-card:hover {
                border-color: var(--accent);
                box-shadow: 0 4px 24px rgba(88, 166, 255, 0.12);
                transform: translateY(-2px);
            }

            /* AGI-2 card accent */
            .g-card.agi2-card:hover {
                border-color: var(--purple);
                box-shadow: 0 4px 24px rgba(188, 140, 255, 0.12);
            }

            /* ── Card Preview (top) ── */
            .g-card-preview {
                position: relative;
                width: 100%;
                aspect-ratio: 1;
                background: #0a0d12;
                overflow: hidden;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            .g-card-preview img,
            .g-card-preview canvas {
                width: 100%;
                height: 100%;
                object-fit: contain;
                image-rendering: pixelated;
                image-rendering: crisp-edges;
                transition: transform 0.3s;
            }
            .g-card:hover .g-card-preview img,
            .g-card:hover .g-card-preview canvas {
                transform: scale(1.05);
            }
            .g-card-preview .loading-text {
                font-family: var(--code);
                font-size: 10px;
                color: #444;
                letter-spacing: 1px;
            }

            /* Play overlay on hover */
            .card-overlay {
                position: absolute;
                inset: 0;
                display: flex;
                align-items: center;
                justify-content: center;
                background: rgba(14, 17, 23, 0.55);
                opacity: 0;
                transition: opacity 0.2s;
            }
            .g-card:hover .card-overlay {
                opacity: 1;
            }
            .play-circle {
                width: 48px;
                height: 48px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 18px;
                color: #fff;
                transition: transform 0.15s;
            }
            .agi3-play {
                background: rgba(63, 185, 80, 0.2);
                border: 2px solid var(--green);
            }
            .agi2-play {
                background: var(--purple-dim);
                border: 2px solid var(--purple);
            }
            .g-card:hover .play-circle {
                transform: scale(1.1);
            }

            /* ── Card Info (bottom) ── */
            .g-card-info {
                padding: 10px 12px;
                display: flex;
                flex-direction: column;
                gap: 4px;
            }
            .g-card-id {
                font-family: var(--pixel);
                font-size: 9px;
                letter-spacing: 0.5px;
            }
            .agi3-card .g-card-id {
                color: var(--accent);
            }
            .agi2-card .g-card-id {
                color: var(--purple);
            }

            .g-card-tags {
                display: flex;
                flex-wrap: wrap;
                gap: 4px;
            }
            .g-tag {
                font-family: var(--code);
                font-size: 8px;
                padding: 2px 6px;
                border-radius: 2px;
            }
            .agi3-card .g-tag {
                background: rgba(88, 166, 255, 0.1);
                border: 1px solid rgba(88, 166, 255, 0.2);
                color: var(--accent);
            }
            .agi2-card .g-tag {
                background: var(--purple-dim);
                border: 1px solid rgba(188, 140, 255, 0.25);
                color: var(--purple);
            }
            .g-card-meta {
                font-family: var(--code);
                font-size: 9px;
                color: var(--text-dim);
            }

            /* ── Empty / No results ── */
            .empty-msg {
                grid-column: 1/-1;
                text-align: center;
                padding: 40px 20px;
                color: var(--text-dim);
                font-size: 13px;
                line-height: 1.6;
            }
            .empty-msg code {
                font-family: var(--code);
                background: rgba(255, 255, 255, 0.06);
                padding: 2px 6px;
                border-radius: 3px;
            }

            /* ── Pagination ── */
            .pagination {
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 16px;
                padding: 16px 0 4px;
            }
            .pag-btn {
                font-family: var(--code);
                font-size: 11px;
                color: var(--text-dim);
                background: var(--panel);
                border: 1px solid var(--border);
                border-radius: 4px;
                padding: 6px 14px;
                cursor: pointer;
                transition: all 0.15s;
            }
            .pag-btn:hover:not(:disabled) {
                border-color: var(--accent);
                color: var(--text-bright);
            }
            .pag-btn:disabled {
                color: #333;
                cursor: default;
                border-color: rgba(48, 54, 61, 0.5);
            }
            .pag-info {
                font-family: var(--code);
                font-size: 11px;
                color: #555;
                min-width: 90px;
                text-align: center;
            }

            /* ── Footer ── */
            #footer {
                padding: 8px 24px;
                text-align: center;
                border-top: 1px solid var(--border);
                font-size: 10px;
                color: var(--text-dim);
                flex-shrink: 0;
            }
            #footer a {
                color: var(--accent);
                text-decoration: none;
            }
            #footer a:hover {
                text-decoration: underline;
            }

            /* ═══ MOBILE ═══ */
            @media (max-width: 900px) {
                #content {
                    flex-direction: column;
                }
                .half:first-child {
                    border-right: none;
                    border-bottom: 1px solid var(--border);
                }
                .half {
                    flex: 1;
                    min-height: 0;
                }
                .card-grid {
                    grid-template-columns: repeat(
                        auto-fill,
                        minmax(160px, 1fr)
                    );
                    gap: 12px;
                }
                .section-head {
                    padding: 14px 16px 12px;
                }
                .card-scroll {
                    padding: 14px 16px 20px;
                }
                .cat-tabs {
                    padding: 0 16px;
                }
            }
            @media (max-width: 600px) {
                #topbar {
                    padding: 8px 12px;
                    gap: 10px;
                }
                .logo {
                    font-size: 10px;
                }
                .tagline {
                    display: none;
                }
                .section-title {
                    font-size: 11px;
                }
                .card-grid {
                    grid-template-columns: repeat(
                        auto-fill,
                        minmax(140px, 1fr)
                    );
                    gap: 10px;
                }
                .section-head {
                    padding: 12px 12px 10px;
                }
                .card-scroll {
                    padding: 10px 12px 16px;
                }
                .cat-tabs {
                    padding: 0 12px;
                }
                .g-card-id {
                    font-size: 8px;
                }
                .g-tag {
                    font-size: 7px;
                }
                .play-circle {
                    width: 36px;
                    height: 36px;
                    font-size: 14px;
                }
            }
        </style>
    </head>
    <body>
        <div id="app">
            <!-- ═══ TOP BAR ═══ -->
            <div id="topbar">
                <a href="/" class="logo">Ethara AI × ARC</a>
                <div class="sep"></div>
                <div class="tagline">Abstraction & Reasoning Corpus</div>
                <div class="spacer"></div>
            </div>

            <!-- ═══ SPLIT CONTENT ═══ -->
            <div id="content">
                <!-- ── LEFT: AGI-2 Tasks ── -->
                <div class="half" id="half-agi2">
                    <div class="section-head">
                        <div class="section-title-row">
                            <span class="section-badge badge-purple"
                                >AGI-2</span
                            >
                            <span class="section-title">ARC Puzzles</span>
                            <span class="section-count" id="agi2-count"></span>
                        </div>
                        <div class="section-desc">
                            Classic pattern recognition puzzles — view examples,
                            identify the rule, solve the test.
                        </div>
                        <div class="section-controls">
                            <input
                                type="text"
                                class="search-box"
                                id="agi2-search"
                                placeholder="Search task ID…"
                            />
                            <label class="upload-btn" for="agi2-upload">
                                ↑ Upload .json
                                <input
                                    type="file"
                                    id="agi2-upload"
                                    accept=".json"
                                />
                            </label>
                        </div>
                    </div>
                    <!-- Category tabs -->
                    <div class="cat-tabs" id="agi2-tabs">
                        <button class="cat-tab active" data-cat="my_tasks">
                            ★ My Tasks
                            <span class="ct-count" id="ct-my_tasks">0</span>
                        </button>
                        <button class="cat-tab" data-cat="training">
                            Training
                            <span class="ct-count" id="ct-training">0</span>
                        </button>
                        <button class="cat-tab" data-cat="evaluation">
                            Evaluation
                            <span class="ct-count" id="ct-evaluation">0</span>
                        </button>
                    </div>
                    <div class="card-scroll" id="agi2-scroll">
                        <div class="card-grid" id="agi2-grid"></div>
                        <div
                            class="pagination"
                            id="agi2-pag"
                            style="display: none"
                        >
                            <button class="pag-btn" id="agi2-prev">
                                ← Prev
                            </button>
                            <span class="pag-info" id="agi2-pag-info"></span>
                            <button class="pag-btn" id="agi2-next">
                                Next →
                            </button>
                        </div>
                    </div>
                </div>

                <!-- ── RIGHT: AGI-3 Games ── -->
                <div class="half" id="half-agi3">
                    <div class="section-head">
                        <div class="section-title-row">
                            <span class="section-badge badge-green">AGI-3</span>
                            <span class="section-title">Interactive Games</span>
                            <span class="section-count" id="agi3-count"></span>
                        </div>
                        <div class="section-desc">
                            Real-time interactive game environments with
                            multiple levels, keyboard controls, and instant
                            feedback.
                        </div>
                        <div class="section-controls">
                            <input
                                type="text"
                                class="search-box"
                                id="agi3-search"
                                placeholder="Search game ID…"
                            />
                            <label class="upload-btn" for="agi3-upload">
                                ↑ Upload game
                                <input
                                    type="file"
                                    id="agi3-upload"
                                    accept=".py,.json"
                                    multiple
                                />
                            </label>
                        </div>
                    </div>
                    <div class="card-scroll" id="agi3-scroll">
                        <div class="card-grid" id="agi3-grid"></div>
                    </div>
                </div>
            </div>

            <!-- ═══ FOOTER ═══ -->
            <div id="footer">
                Powered by
                <a href="https://ethara.ai" target="_blank">Ethara AI</a> ·
                <a
                    href="https://github.com/Raj602-stack/Arc-Agi3"
                    target="_blank"
                    >GitHub</a
                >
            </div>
        </div>

        <script>
            // ══════════════════════════════════════════════════════════════
            //  Unified Landing Page — AGI-2 + AGI-3 side-by-side
            // ══════════════════════════════════════════════════════════════

            // ── State ────────────────────────────────────────────────────
            var agi2Index = null; // {my_tasks:[], training:[], evaluation:[]}
            var agi2Category = "my_tasks";
            var agi2Search = "";
            var agi2Page = 0;
            var AGI2_PER_PAGE = 18;

            var agi3Games = []; // [{game_id, tags, ...}, ...]
            var agi3Search = "";

            // ── DOM refs ─────────────────────────────────────────────────
            var agi2Grid = document.getElementById("agi2-grid");
            var agi2Pag = document.getElementById("agi2-pag");
            var agi3Grid = document.getElementById("agi3-grid");

            // ══════════════════════════════════════════════════════════════
            //  AGI-3 — Fetch games and render cards
            // ══════════════════════════════════════════════════════════════

            function fetchAgi3Games() {
                fetch("/api/games")
                    .then(function (r) {
                        return r.json();
                    })
                    .then(function (data) {
                        agi3Games = data.games || [];
                        document.getElementById("agi3-count").textContent =
                            agi3Games.length +
                            " game" +
                            (agi3Games.length !== 1 ? "s" : "");
                        renderAgi3();
                    })
                    .catch(function (err) {
                        agi3Grid.innerHTML =
                            '<div class="empty-msg">Could not load games.<br>' +
                            err +
                            "</div>";
                    });
            }

            function renderAgi3() {
                var q = agi3Search.toLowerCase();
                var filtered = agi3Games.filter(function (g) {
                    return (
                        !q ||
                        g.game_id.toLowerCase().indexOf(q) !== -1 ||
                        (g.tags || []).join(" ").toLowerCase().indexOf(q) !== -1
                    );
                });

                agi3Grid.innerHTML = "";
                if (filtered.length === 0) {
                    agi3Grid.innerHTML = q
                        ? '<div class="empty-msg">No games match "<code>' +
                          agi3Search +
                          '</code>"</div>'
                        : '<div class="empty-msg">No games found.<br>Drop a game into <code>environment_files/</code> or use Upload.</div>';
                    return;
                }

                filtered.forEach(function (g) {
                    var card = document.createElement("div");
                    card.className = "g-card agi3-card";

                    var previewDiv = document.createElement("div");
                    previewDiv.className = "g-card-preview";
                    previewDiv.innerHTML =
                        '<div class="loading-text">LOADING…</div>';

                    var overlay = document.createElement("div");
                    overlay.className = "card-overlay";
                    overlay.innerHTML =
                        '<div class="play-circle agi3-play">▶</div>';
                    previewDiv.appendChild(overlay);

                    var img = new Image();
                    img.onload = function () {
                        var lt = previewDiv.querySelector(".loading-text");
                        if (lt) lt.remove();
                        previewDiv.insertBefore(img, previewDiv.firstChild);
                    };
                    img.onerror = function () {
                        var lt = previewDiv.querySelector(".loading-text");
                        if (lt) lt.textContent = "NO PREVIEW";
                    };
                    img.src =
                        "/api/games/" +
                        encodeURIComponent(g.game_id) +
                        "/preview";

                    var info = document.createElement("div");
                    info.className = "g-card-info";

                    var idEl = document.createElement("div");
                    idEl.className = "g-card-id";
                    idEl.textContent = g.game_id;

                    var tagsEl = document.createElement("div");
                    tagsEl.className = "g-card-tags";
                    (g.tags || []).forEach(function (t) {
                        var tag = document.createElement("span");
                        tag.className = "g-tag";
                        tag.textContent = t;
                        tagsEl.appendChild(tag);
                    });

                    info.appendChild(idEl);
                    if ((g.tags || []).length) info.appendChild(tagsEl);

                    card.appendChild(previewDiv);
                    card.appendChild(info);

                    card.addEventListener("click", function () {
                        window.location.href =
                            "/arc-agi-3/game/" + encodeURIComponent(g.game_id);
                    });

                    agi3Grid.appendChild(card);
                });
            }

            // ── AGI-3 Search ──
            document
                .getElementById("agi3-search")
                .addEventListener("input", function () {
                    agi3Search = this.value.trim();
                    renderAgi3();
                });

            // ── AGI-3 Upload ──
            document
                .getElementById("agi3-upload")
                .addEventListener("change", function (e) {
                    var files = e.target.files;
                    if (!files || files.length === 0) return;

                    var form = new FormData();
                    for (var i = 0; i < files.length; i++) {
                        var name = files[i].name;
                        if (name.endsWith(".py"))
                            form.append("game_py", files[i]);
                        if (name.endsWith(".json"))
                            form.append("metadata_json", files[i]);
                    }

                    fetch("/api/upload", { method: "POST", body: form })
                        .then(function (r) {
                            return r.json();
                        })
                        .then(function (data) {
                            if (data.error) {
                                alert("Upload error: " + data.error);
                            } else {
                                alert(
                                    "Game uploaded: " + (data.game_id || "OK"),
                                );
                                fetchAgi3Games();
                            }
                        })
                        .catch(function (err) {
                            alert("Upload failed: " + err);
                        });

                    e.target.value = "";
                });

            // ══════════════════════════════════════════════════════════════
            //  AGI-2 — Fetch task index and render cards
            // ══════════════════════════════════════════════════════════════

            function fetchAgi2Index() {
                fetch("/api/agi2/tasks")
                    .then(function (r) {
                        return r.json();
                    })
                    .then(function (data) {
                        agi2Index = data;
                        updateAgi2TabCounts();
                        renderAgi2();
                    })
                    .catch(function (err) {
                        agi2Grid.innerHTML =
                            '<div class="empty-msg">Could not load task index.<br>' +
                            err +
                            "</div>";
                    });
            }

            function updateAgi2TabCounts() {
                if (!agi2Index) return;
                var cats = ["my_tasks", "training", "evaluation"];
                var total = 0;
                cats.forEach(function (c) {
                    var arr = agi2Index[c] || [];
                    total += arr.length;
                    var el = document.getElementById("ct-" + c);
                    if (el) el.textContent = arr.length;
                });
                document.getElementById("agi2-count").textContent =
                    total + " puzzles";
            }

            function getAgi2Files() {
                if (!agi2Index) return [];
                var files = agi2Index[agi2Category] || [];
                if (agi2Search) {
                    var q = agi2Search.toLowerCase();
                    files = files.filter(function (f) {
                        return f.toLowerCase().indexOf(q) !== -1;
                    });
                }
                return files;
            }

            function renderAgi2() {
                agi2Grid.innerHTML = "";

                var files = getAgi2Files();

                // Update count display for filtered
                if (agi2Search) {
                    document.getElementById("agi2-count").textContent =
                        files.length +
                        " result" +
                        (files.length !== 1 ? "s" : "");
                } else {
                    updateAgi2TabCounts();
                }

                // Pagination
                var totalPages = Math.max(
                    1,
                    Math.ceil(files.length / AGI2_PER_PAGE),
                );
                if (agi2Page >= totalPages) agi2Page = totalPages - 1;
                if (agi2Page < 0) agi2Page = 0;

                var start = agi2Page * AGI2_PER_PAGE;
                var end = Math.min(start + AGI2_PER_PAGE, files.length);
                var pageFiles = files.slice(start, end);

                if (files.length === 0) {
                    agi2Grid.innerHTML = agi2Search
                        ? '<div class="empty-msg">No tasks match "<code>' +
                          agi2Search +
                          '</code>"</div>'
                        : '<div class="empty-msg">No tasks in this category.</div>';
                    agi2Pag.style.display = "none";
                    return;
                }

                // Show/hide pagination
                if (totalPages > 1) {
                    agi2Pag.style.display = "flex";
                    document.getElementById("agi2-pag-info").textContent =
                        "Page " + (agi2Page + 1) + " / " + totalPages;
                    document.getElementById("agi2-prev").disabled =
                        agi2Page === 0;
                    document.getElementById("agi2-next").disabled =
                        agi2Page >= totalPages - 1;
                } else {
                    agi2Pag.style.display = "none";
                }

                pageFiles.forEach(function (filename, i) {
                    var card = buildAgi2Card(filename, start + i);
                    agi2Grid.appendChild(card);
                });
            }

            function buildAgi2Card(filename, globalIdx) {
                var card = document.createElement("div");
                card.className = "g-card agi2-card";

                var taskId = filename.replace(".json", "");

                // Preview
                var previewDiv = document.createElement("div");
                previewDiv.className = "g-card-preview";
                previewDiv.innerHTML =
                    '<div class="loading-text">LOADING…</div>';

                var overlay = document.createElement("div");
                overlay.className = "card-overlay";
                overlay.innerHTML =
                    '<div class="play-circle agi2-play">▶</div>';
                previewDiv.appendChild(overlay);

                var img = new Image();
                img.onload = function () {
                    var lt = previewDiv.querySelector(".loading-text");
                    if (lt) lt.remove();
                    previewDiv.insertBefore(img, previewDiv.firstChild);
                };
                img.onerror = function () {
                    var lt = previewDiv.querySelector(".loading-text");
                    if (lt) lt.textContent = "NO PREVIEW";
                };
                img.src =
                    "/api/agi2/task-preview/" +
                    encodeURIComponent(agi2Category) +
                    "/" +
                    encodeURIComponent(filename);

                // Info
                var info = document.createElement("div");
                info.className = "g-card-info";

                var idEl = document.createElement("div");
                idEl.className = "g-card-id";
                idEl.textContent = taskId;

                var tagsEl = document.createElement("div");
                tagsEl.className = "g-card-tags";

                var catTag = document.createElement("span");
                catTag.className = "g-tag";
                catTag.textContent =
                    agi2Category === "my_tasks" ? "my task" : agi2Category;
                tagsEl.appendChild(catTag);

                info.appendChild(idEl);
                info.appendChild(tagsEl);

                card.appendChild(previewDiv);
                card.appendChild(info);

                // Click → open AGI-2 with this task
                card.addEventListener("click", function () {
                    window.location.href =
                        "/arc-agi-2/?task=" +
                        encodeURIComponent(agi2Category) +
                        "/" +
                        encodeURIComponent(filename);
                });

                return card;
            }

            // ── AGI-2 Tab switching ──
            document
                .getElementById("agi2-tabs")
                .addEventListener("click", function (e) {
                    var btn = e.target.closest(".cat-tab");
                    if (!btn) return;
                    var cat = btn.getAttribute("data-cat");
                    if (cat === agi2Category) return;

                    document
                        .querySelectorAll("#agi2-tabs .cat-tab")
                        .forEach(function (t) {
                            t.classList.remove("active");
                        });
                    btn.classList.add("active");

                    agi2Category = cat;
                    agi2Page = 0;
                    renderAgi2();
                    document.getElementById("agi2-scroll").scrollTop = 0;
                });

            // ── AGI-2 Search ──
            (function () {
                var timer = null;
                document
                    .getElementById("agi2-search")
                    .addEventListener("input", function () {
                        var val = this.value.trim();
                        clearTimeout(timer);
                        timer = setTimeout(function () {
                            agi2Search = val;
                            agi2Page = 0;
                            renderAgi2();
                        }, 200);
                    });
            })();

            // ── AGI-2 Pagination ──
            document
                .getElementById("agi2-prev")
                .addEventListener("click", function () {
                    if (agi2Page > 0) {
                        agi2Page--;
                        renderAgi2();
                        document.getElementById("agi2-scroll").scrollTop = 0;
                    }
                });
            document
                .getElementById("agi2-next")
                .addEventListener("click", function () {
                    var files = getAgi2Files();
                    var totalPages = Math.ceil(files.length / AGI2_PER_PAGE);
                    if (agi2Page < totalPages - 1) {
                        agi2Page++;
                        renderAgi2();
                        document.getElementById("agi2-scroll").scrollTop = 0;
                    }
                });

            // ── AGI-2 Upload ──
            document
                .getElementById("agi2-upload")
                .addEventListener("change", function (e) {
                    var file = e.target.files[0];
                    if (!file) return;

                    if (!file.name.endsWith(".json")) {
                        alert("Please upload a .json task file.");
                        e.target.value = "";
                        return;
                    }

                    // Read and validate, then open in AGI-2
                    var reader = new FileReader();
                    reader.onload = function (ev) {
                        try {
                            var data = JSON.parse(ev.target.result);
                            if (!data.train || !data.test)
                                throw new Error("Missing train/test");
                            // Store in sessionStorage so AGI-2 page can pick it up
                            sessionStorage.setItem(
                                "agi2_upload_task",
                                ev.target.result,
                            );
                            sessionStorage.setItem(
                                "agi2_upload_name",
                                file.name,
                            );
                            window.location.href = "/arc-agi-2/?uploaded=1";
                        } catch (err) {
                            alert("Invalid task file: " + err.message);
                        }
                    };
                    reader.readAsText(file);
                    e.target.value = "";
                });

            // ══════════════════════════════════════════════════════════════
            //  INIT
            // ══════════════════════════════════════════════════════════════
            fetchAgi3Games();
            fetchAgi2Index();
        </script>
    </body>
</html>
