<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Ethara AI √ó ARC AGI-3</title>
        <style>
            @import url("https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Press+Start+2P&display=swap");

            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            :root {
                --bg: #0e1117;
                --panel: #161b22;
                --border: #30363d;
                --border-bright: #58a6ff;
                --text: #c9d1d9;
                --text-dim: #8b949e;
                --text-bright: #f0f6fc;
                --accent: #58a6ff;
                --green: #3fb950;
                --green-dim: #238636;
                --yellow: #d29922;
                --red: #f85149;
                --purple: #bc8cff;
                --cyan: #39d2c0;
                --orange: #f0883e;
                --mono: "Share Tech Mono", "Courier New", monospace;
                --pixel: "Press Start 2P", monospace;
            }

            body {
                background: var(--bg);
                color: var(--text);
                font-family: var(--mono);
                min-height: 100vh;
                display: flex;
                flex-direction: column;
            }

            /* ‚îÄ‚îÄ Top bar ‚îÄ‚îÄ */
            #topbar {
                display: flex;
                align-items: center;
                gap: 16px;
                padding: 10px 20px;
                background: var(--panel);
                border-bottom: 1px solid var(--border);
                flex-shrink: 0;
            }
            #topbar .logo {
                font-family: var(--pixel);
                font-size: 12px;
                color: var(--accent);
                white-space: nowrap;
            }
            #topbar .sep {
                width: 1px;
                height: 20px;
                background: var(--border);
            }
            #topbar .status {
                font-size: 12px;
                color: var(--text-dim);
            }
            #topbar .status.connected {
                color: var(--green);
            }
            #topbar .status.disconnected {
                color: var(--red);
            }
            .spacer {
                flex: 1;
            }
            .top-btn {
                font-family: var(--mono);
                font-size: 12px;
                padding: 5px 14px;
                background: transparent;
                border: 1px solid var(--border);
                color: var(--text);
                cursor: pointer;
                transition: all 0.15s;
            }
            .top-btn:hover {
                border-color: var(--accent);
                color: var(--accent);
            }

            /* ‚îÄ‚îÄ Main layout ‚îÄ‚îÄ */
            #main {
                flex: 1;
                display: flex;
                overflow: hidden;
            }

            /* ‚îÄ‚îÄ Lobby (game picker) ‚îÄ‚îÄ */
            #lobby {
                flex: 1;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                gap: 24px;
                padding: 40px;
            }
            #lobby.hidden {
                display: none;
            }

            #lobby h1 {
                font-family: var(--pixel);
                font-size: 20px;
                color: var(--accent);
                text-align: center;
                line-height: 1.6;
            }
            #lobby .sub {
                color: var(--text-dim);
                font-size: 13px;
                text-align: center;
                max-width: 500px;
                line-height: 1.6;
            }

            /* Game cards */
            .game-list {
                display: flex;
                flex-wrap: wrap;
                gap: 16px;
                justify-content: center;
                max-width: 800px;
            }
            .game-card {
                background: var(--panel);
                border: 1px solid var(--border);
                padding: 20px;
                width: 340px;
                cursor: pointer;
                transition: all 0.15s;
                position: relative;
            }
            .game-card:hover {
                border-color: var(--accent);
                box-shadow: 0 0 16px rgba(88, 166, 255, 0.15);
                transform: translateY(-2px);
            }
            .game-card .gid {
                font-family: var(--pixel);
                font-size: 11px;
                color: var(--accent);
                margin-bottom: 8px;
            }
            .game-card .tags {
                display: flex;
                flex-wrap: wrap;
                gap: 4px;
                margin-top: 8px;
            }
            .tag {
                font-size: 10px;
                padding: 2px 8px;
                background: rgba(88, 166, 255, 0.1);
                border: 1px solid rgba(88, 166, 255, 0.2);
                color: var(--accent);
            }
            .game-card .meta {
                font-size: 11px;
                color: var(--text-dim);
                margin-top: 6px;
            }

            .no-games {
                color: var(--text-dim);
                font-size: 14px;
                text-align: center;
                padding: 30px;
                border: 1px dashed var(--border);
                max-width: 400px;
            }

            .btn-row {
                display: flex;
                gap: 10px;
                width: 100%;
            }
            .btn-primary {
                flex: 1;
                font-family: var(--mono);
                font-size: 14px;
                padding: 10px;
                background: var(--green-dim);
                border: 1px solid var(--green);
                color: var(--text-bright);
                cursor: pointer;
                transition: all 0.15s;
                letter-spacing: 1px;
            }
            .btn-primary:hover {
                background: var(--green);
                color: #fff;
            }
            .btn-secondary {
                font-family: var(--mono);
                font-size: 13px;
                padding: 10px 16px;
                background: transparent;
                border: 1px solid var(--border);
                color: var(--text-dim);
                cursor: pointer;
            }
            .btn-secondary:hover {
                border-color: var(--text);
                color: var(--text);
            }

            /* ‚îÄ‚îÄ Upload panel ‚îÄ‚îÄ */
            #upload-panel {
                display: none;
                flex-direction: column;
                align-items: center;
                gap: 16px;
                padding: 30px;
                max-width: 500px;
                width: 100%;
            }
            #upload-panel.show {
                display: flex;
            }
            #upload-panel h2 {
                font-family: var(--pixel);
                font-size: 12px;
                color: var(--purple);
            }
            .drop-zone {
                width: 100%;
                padding: 40px 20px;
                border: 2px dashed var(--border);
                text-align: center;
                color: var(--text-dim);
                font-size: 13px;
                line-height: 1.8;
                cursor: pointer;
                transition: all 0.15s;
            }
            .drop-zone:hover,
            .drop-zone.dragover {
                border-color: var(--purple);
                color: var(--purple);
                background: rgba(188, 140, 255, 0.05);
            }
            .drop-zone input {
                display: none;
            }
            .file-list {
                width: 100%;
                font-size: 12px;
                color: var(--text-dim);
            }
            .file-list .file-item {
                padding: 6px 10px;
                border: 1px solid var(--border);
                margin-bottom: 4px;
                display: flex;
                justify-content: space-between;
            }
            .file-item .fname {
                color: var(--cyan);
            }
            .file-item .fsize {
                color: var(--text-dim);
            }
            #upload-status {
                font-size: 12px;
                min-height: 18px;
            }
            #upload-status.ok {
                color: var(--green);
            }
            #upload-status.err {
                color: var(--red);
            }

            /* ‚îÄ‚îÄ Admin panel ‚îÄ‚îÄ */
            #admin-panel {
                display: none;
                flex-direction: column;
                align-items: center;
                gap: 16px;
                padding: 30px;
                max-width: 600px;
                width: 100%;
            }
            #admin-panel.show {
                display: flex;
            }
            #admin-panel h2 {
                font-family: var(--pixel);
                font-size: 12px;
                color: var(--orange);
            }
            .admin-login {
                display: flex;
                flex-direction: column;
                gap: 10px;
                width: 100%;
                max-width: 320px;
            }
            .admin-login label {
                font-size: 11px;
                color: var(--text-dim);
                letter-spacing: 1px;
                text-transform: uppercase;
            }
            .admin-login input {
                font-family: var(--mono);
                font-size: 13px;
                padding: 8px 12px;
                background: var(--bg);
                border: 1px solid var(--border);
                color: var(--text);
                outline: none;
            }
            .admin-login input:focus {
                border-color: var(--orange);
            }
            #admin-status {
                font-size: 12px;
                min-height: 18px;
            }
            #admin-status.ok {
                color: var(--green);
            }
            #admin-status.err {
                color: var(--red);
            }
            .admin-games {
                width: 100%;
                display: flex;
                flex-direction: column;
                gap: 6px;
                margin-top: 10px;
            }
            .admin-game-row {
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 10px 14px;
                border: 1px solid var(--border);
                background: var(--bg);
            }
            .admin-game-row .agr-id {
                font-family: var(--pixel);
                font-size: 10px;
                color: var(--cyan);
            }
            .admin-game-row .agr-tags {
                font-size: 11px;
                color: var(--text-dim);
                margin-top: 2px;
            }
            .admin-game-row .agr-delete {
                font-family: var(--mono);
                font-size: 11px;
                padding: 5px 12px;
                background: transparent;
                border: 1px solid var(--red);
                color: var(--red);
                cursor: pointer;
                transition: all 0.15s;
                letter-spacing: 1px;
                flex-shrink: 0;
            }
            .admin-game-row .agr-delete:hover {
                background: var(--red);
                color: #fff;
            }
            .admin-game-row .agr-delete:disabled {
                opacity: 0.4;
                cursor: not-allowed;
            }
            .admin-game-row .agr-delete:disabled:hover {
                background: transparent;
                color: var(--red);
            }

            /* ‚îÄ‚îÄ Game view ‚îÄ‚îÄ */
            #game-view {
                flex: 1;
                display: none;
                flex-direction: row;
                overflow: hidden;
            }
            #game-view.show {
                display: flex;
            }

            /* Grid area */
            #grid-area {
                flex: 1;
                display: flex;
                align-items: center;
                justify-content: center;
                position: relative;
                background: #0d1117;
                min-width: 0;
            }
            #grid-wrapper {
                position: relative;
                line-height: 0;
            }
            #grid-wrapper::before {
                content: "";
                position: absolute;
                inset: -4px;
                border: 1px solid var(--border);
                pointer-events: none;
            }
            #game-canvas {
                image-rendering: pixelated;
                image-rendering: crisp-edges;
                display: block;
                background: #0d1117;
            }

            /* Sidebar */
            #sidebar {
                width: 280px;
                min-width: 280px;
                background: var(--panel);
                border-left: 1px solid var(--border);
                display: flex;
                flex-direction: column;
                overflow-y: auto;
                font-size: 13px;
            }

            .sb-section {
                padding: 12px 16px;
                border-bottom: 1px solid var(--border);
            }
            .sb-section h3 {
                font-size: 10px;
                color: var(--text-dim);
                letter-spacing: 2px;
                text-transform: uppercase;
                margin-bottom: 8px;
            }

            #sb-game-id {
                font-family: var(--pixel);
                font-size: 10px;
                color: var(--accent);
                margin-bottom: 4px;
            }
            #sb-state {
                font-size: 14px;
                font-weight: bold;
            }
            #sb-state.playing {
                color: var(--green);
            }
            #sb-state.won {
                color: var(--yellow);
            }
            #sb-state.lost {
                color: var(--red);
            }

            /* Progress */
            .progress-bar {
                display: flex;
                gap: 2px;
                margin: 6px 0;
            }
            .progress-seg {
                flex: 1;
                height: 8px;
                background: var(--bg);
                border: 1px solid var(--border);
                transition: background 0.3s;
            }
            .progress-seg.filled {
                background: var(--green);
                border-color: var(--green);
            }

            #sb-actions {
                font-size: 12px;
                color: var(--text-dim);
            }

            /* Controls legend */
            .controls-list {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 3px 14px;
            }
            .ctrl-item {
                display: flex;
                align-items: center;
                gap: 6px;
                font-size: 12px;
                color: var(--text-dim);
            }
            kbd {
                display: inline-block;
                background: var(--bg);
                border: 1px solid var(--border);
                padding: 1px 6px;
                font-family: var(--mono);
                font-size: 11px;
                color: var(--text);
                min-width: 24px;
                text-align: center;
            }

            /* Available actions */
            .avail-list {
                display: flex;
                flex-direction: column;
                gap: 2px;
            }
            .avail-item {
                font-size: 12px;
                color: var(--green);
                padding-left: 6px;
                opacity: 0.8;
            }

            /* Sidebar buttons */
            .sb-btn {
                width: 100%;
                font-family: var(--mono);
                font-size: 12px;
                padding: 8px;
                background: transparent;
                border: 1px solid var(--border);
                color: var(--text);
                cursor: pointer;
                margin-top: 6px;
                transition: all 0.15s;
                letter-spacing: 1px;
            }
            .sb-btn:hover {
                border-color: var(--accent);
                color: var(--accent);
            }
            .sb-btn.danger:hover {
                border-color: var(--red);
                color: var(--red);
            }

            .sb-footer {
                margin-top: auto;
                padding: 10px 16px;
                font-size: 10px;
                color: var(--text-dim);
                border-top: 1px solid var(--border);
            }

            /* ‚îÄ‚îÄ Victory overlay ‚îÄ‚îÄ */
            #victory-overlay {
                position: fixed;
                inset: 0;
                z-index: 200;
                display: none;
                align-items: center;
                justify-content: center;
                background: rgba(14, 17, 23, 0.85);
                backdrop-filter: blur(6px);
            }
            #victory-overlay.show {
                display: flex;
            }
            .victory-box {
                text-align: center;
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 16px;
                padding: 40px;
                background: var(--panel);
                border: 1px solid var(--green);
                max-width: 460px;
            }
            .victory-box h1 {
                font-family: var(--pixel);
                font-size: 16px;
                color: var(--green);
            }
            .victory-box .stats {
                font-size: 14px;
                color: var(--text);
                line-height: 1.8;
            }

            /* ‚îÄ‚îÄ Toast ‚îÄ‚îÄ */
            #toast {
                position: fixed;
                top: 16px;
                left: 50%;
                transform: translateX(-50%) translateY(-60px);
                z-index: 600;
                background: var(--panel);
                border: 1px solid var(--border);
                padding: 8px 24px;
                font-size: 13px;
                color: var(--text);
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
                transition: transform 0.25s ease;
                pointer-events: none;
            }
            #toast.show {
                transform: translateX(-50%) translateY(0);
            }

            /* ‚îÄ‚îÄ Mobile controls ‚îÄ‚îÄ */
            #mobile-controls {
                display: none;
                position: fixed;
                bottom: 12px;
                left: 50%;
                transform: translateX(-50%);
                z-index: 100;
                gap: 6px;
            }
            .dpad {
                display: grid;
                grid-template-areas:
                    ". up ."
                    "left . right"
                    ". down .";
                gap: 4px;
            }
            .dpad-btn {
                width: 52px;
                height: 52px;
                font-size: 20px;
                display: flex;
                align-items: center;
                justify-content: center;
                background: var(--panel);
                border: 1px solid var(--border);
                color: var(--text);
                cursor: pointer;
                -webkit-tap-highlight-color: transparent;
                touch-action: manipulation;
            }
            .dpad-btn:active {
                background: var(--border);
            }
            .dpad-btn.up {
                grid-area: up;
            }
            .dpad-btn.left {
                grid-area: left;
            }
            .dpad-btn.right {
                grid-area: right;
            }
            .dpad-btn.down {
                grid-area: down;
            }
            .mobile-btns {
                display: flex;
                gap: 6px;
                align-items: center;
                margin-left: 14px;
            }
            .mobile-btns .dpad-btn {
                width: 48px;
                height: 48px;
                font-size: 10px;
                letter-spacing: 0.5px;
            }

            /* ‚îÄ‚îÄ Responsive ‚îÄ‚îÄ */
            @media (max-width: 900px) {
                #sidebar {
                    display: none;
                }
                #mobile-controls {
                    display: flex;
                }
                #game-canvas {
                    max-height: calc(100vh - 220px);
                }
            }
            @media (max-width: 600px) {
                #lobby {
                    padding: 20px;
                }
                #lobby h1 {
                    font-size: 14px;
                }
                .game-card {
                    width: 100%;
                }
                .dpad-btn {
                    width: 44px;
                    height: 44px;
                    font-size: 16px;
                }
            }
        </style>
    </head>
    <body>
        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TOP BAR ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        <div id="topbar">
            <div class="logo" id="btn-logo" style="cursor: pointer">
                Ethara AI √ó ARC AGI-3
            </div>
            <div class="sep"></div>
            <div class="status disconnected" id="conn-status">
                ‚óè DISCONNECTED
            </div>
            <div class="spacer"></div>
            <button class="top-btn" id="btn-lobby" style="display: none">
                ‚Üê GAMES
            </button>
            <button
                class="top-btn"
                id="btn-admin"
                style="color: var(--orange); border-color: var(--orange)"
            >
                üîí ADMIN
            </button>
            <button class="top-btn" id="btn-upload">UPLOAD GAME</button>
        </div>

        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MAIN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        <div id="main">
            <!-- ‚îÄ‚îÄ Lobby ‚îÄ‚îÄ -->
            <div id="lobby">
                <h1>Ethara AI √ó ARC AGI-3</h1>
                <div class="sub">
                    Drop any ARC-AGI game into
                    <code>environment_files/</code> and it appears here
                    automatically. Or use the <strong>UPLOAD</strong> button to
                    add one from your browser.
                </div>

                <div class="game-list" id="game-list"></div>

                <!-- Admin panel -->
                <div id="admin-panel">
                    <h2>üîí ADMIN PANEL</h2>
                    <div class="admin-login" id="admin-login-form">
                        <label>USERNAME</label>
                        <input
                            type="text"
                            id="admin-user"
                            value=""
                            placeholder="admin"
                            spellcheck="false"
                            autocomplete="off"
                        />
                        <label>PASSWORD</label>
                        <input
                            type="password"
                            id="admin-pass"
                            value=""
                            placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                        />
                        <div class="btn-row">
                            <button class="btn-secondary" id="btn-admin-back">
                                BACK
                            </button>
                            <button class="btn-primary" id="btn-admin-login">
                                LOGIN
                            </button>
                        </div>
                        <div id="admin-status"></div>
                    </div>
                    <div
                        class="admin-games"
                        id="admin-games"
                        style="display: none"
                    >
                        <div
                            style="
                                font-size: 12px;
                                color: var(--text-dim);
                                margin-bottom: 6px;
                            "
                        >
                            Select a game to delete:
                        </div>
                        <div id="admin-games-list"></div>
                        <div class="btn-row" style="margin-top: 12px">
                            <button class="btn-secondary" id="btn-admin-logout">
                                LOGOUT
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Upload panel -->
                <div id="upload-panel">
                    <h2>UPLOAD GAME FILES</h2>
                    <div class="sub" style="font-size: 12px">
                        Select or drag-and-drop a <strong>game .py</strong> file
                        and a <strong>metadata.json</strong> file.
                    </div>
                    <div class="drop-zone" id="drop-zone">
                        <div>üìÅ Click or drop files here</div>
                        <div style="margin-top: 6px; font-size: 11px">
                            Requires: *.py + metadata.json
                        </div>
                        <input
                            type="file"
                            id="file-input"
                            multiple
                            accept=".py,.json"
                        />
                    </div>
                    <div class="file-list" id="file-list"></div>
                    <div class="btn-row">
                        <button class="btn-secondary" id="btn-upload-back">
                            BACK
                        </button>
                        <button class="btn-primary" id="btn-do-upload" disabled>
                            UPLOAD &amp; RUN
                        </button>
                    </div>
                    <div id="upload-status"></div>
                </div>
            </div>

            <!-- ‚îÄ‚îÄ Game view ‚îÄ‚îÄ -->
            <div id="game-view">
                <div id="grid-area">
                    <div id="grid-wrapper">
                        <canvas
                            id="game-canvas"
                            width="512"
                            height="512"
                        ></canvas>
                    </div>
                </div>
                <div id="sidebar">
                    <div class="sb-section">
                        <h3>GAME</h3>
                        <div id="sb-game-id">‚Äî</div>
                        <div id="sb-state" class="playing">LOADING‚Ä¶</div>
                    </div>
                    <div class="sb-section">
                        <h3>PROGRESS</h3>
                        <div class="progress-bar" id="progress-bar"></div>
                        <div id="sb-actions">ACTIONS: 0</div>
                    </div>
                    <div class="sb-section">
                        <h3>CONTROLS</h3>
                        <div class="controls-list">
                            <div class="ctrl-item">
                                <kbd>W</kbd><kbd>‚Üë</kbd> UP
                            </div>
                            <div class="ctrl-item">
                                <kbd>S</kbd><kbd>‚Üì</kbd> DN
                            </div>
                            <div class="ctrl-item">
                                <kbd>A</kbd><kbd>‚Üê</kbd> LT
                            </div>
                            <div class="ctrl-item">
                                <kbd>D</kbd><kbd>‚Üí</kbd> RT
                            </div>
                            <div class="ctrl-item"><kbd>Space</kbd> ACT</div>
                            <div class="ctrl-item"><kbd>Click</kbd> CLICK</div>
                            <div class="ctrl-item"><kbd>‚åòZ</kbd> UNDO</div>
                            <div class="ctrl-item"><kbd>R</kbd> RESET</div>
                            <div class="ctrl-item"><kbd>‚åòR</kbd> RESTART</div>
                        </div>
                    </div>
                    <div class="sb-section">
                        <h3>AVAILABLE</h3>
                        <div class="avail-list" id="avail-list"></div>
                    </div>
                    <div class="sb-section">
                        <button class="sb-btn" id="btn-restart">
                            RESTART GAME
                        </button>
                        <button class="sb-btn danger" id="btn-back-lobby">
                            ‚Üê BACK TO GAMES
                        </button>
                    </div>
                    <div class="sb-footer">
                        <span id="sb-session">‚Äî</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê VICTORY ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        <div id="victory-overlay">
            <div class="victory-box">
                <h1>üéâ ALL LEVELS COMPLETE</h1>
                <div class="stats" id="victory-stats"></div>
                <button
                    class="btn-primary"
                    id="btn-play-again"
                    style="max-width: 250px"
                >
                    PLAY AGAIN
                </button>
                <button class="btn-secondary" id="btn-victory-lobby">
                    BACK TO GAMES
                </button>
            </div>
        </div>

        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MOBILE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        <div id="mobile-controls">
            <div class="dpad">
                <button class="dpad-btn up" data-action="up">‚ñ≤</button>
                <button class="dpad-btn left" data-action="left">‚óÑ</button>
                <button class="dpad-btn right" data-action="right">‚ñ∫</button>
                <button class="dpad-btn down" data-action="down">‚ñº</button>
            </div>
            <div class="mobile-btns">
                <button class="dpad-btn" data-action="action5">ACT</button>
                <button class="dpad-btn" data-action="undo">UNDO</button>
            </div>
        </div>

        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TOAST ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        <div id="toast"></div>

        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SCRIPTS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.min.js"></script>
        <script>
            (function () {
                "use strict";

                // ‚îÄ‚îÄ Elements ‚îÄ‚îÄ
                const $ = (s) => document.getElementById(s);
                const connStatus = $("conn-status");
                const lobby = $("lobby");
                const gameListEl = $("game-list");
                const uploadPanel = $("upload-panel");
                const gameView = $("game-view");
                const canvas = $("game-canvas");
                const ctx = canvas.getContext("2d");
                const toastEl = $("toast");
                const victoryOverlay = $("victory-overlay");
                const victoryStats = $("victory-stats");
                const dropZone = $("drop-zone");
                const fileInput = $("file-input");
                const fileListEl = $("file-list");
                const uploadStatus = $("upload-status");

                // Sidebar
                const sbGameId = $("sb-game-id");
                const sbState = $("sb-state");
                const sbActions = $("sb-actions");
                const sbSession = $("sb-session");
                const progressBar = $("progress-bar");
                const availList = $("avail-list");

                // ‚îÄ‚îÄ State ‚îÄ‚îÄ
                let socket = null;
                let sessionId = null;
                let selectedGameId = null;
                let gameState = null;
                let prevLevels = 0;
                let frameImg = new Image();
                let toastTimer = null;
                let uploadedFiles = { py: null, json: null };
                let adminCreds = { username: null, password: null };
                let adminLoggedIn = false;
                let autoStartGameId = null;

                // ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ
                function showToast(msg, ms) {
                    ms = ms || 2500;
                    toastEl.textContent = msg;
                    toastEl.classList.add("show");
                    if (toastTimer) clearTimeout(toastTimer);
                    toastTimer = setTimeout(
                        () => toastEl.classList.remove("show"),
                        ms,
                    );
                }

                function pad(n, len) {
                    return String(n).padStart(len, "0");
                }

                // ‚îÄ‚îÄ Navigation ‚îÄ‚îÄ
                function showLobby() {
                    lobby.classList.remove("hidden");
                    gameView.classList.remove("show");
                    victoryOverlay.classList.remove("show");
                    $("btn-lobby").style.display = "none";
                    uploadPanel.classList.remove("show");
                    $("admin-panel").classList.remove("show");
                    gameListEl.style.display = "";
                    history.pushState(null, "", "/");
                    fetchGames();
                }

                function launchGame(gameId) {
                    selectedGameId = gameId;
                    history.pushState(
                        null,
                        "",
                        "/game/" + encodeURIComponent(gameId),
                    );
                    startGame();
                }

                function showUpload() {
                    gameListEl.style.display = "none";
                    $("admin-panel").classList.remove("show");
                    uploadPanel.classList.add("show");
                    uploadedFiles = { py: null, json: null };
                    fileListEl.innerHTML = "";
                    uploadStatus.textContent = "";
                    uploadStatus.className = "";
                    $("btn-do-upload").disabled = true;
                }

                function showAdmin() {
                    gameListEl.style.display = "none";
                    uploadPanel.classList.remove("show");
                    $("admin-panel").classList.add("show");
                    if (adminLoggedIn) {
                        $("admin-login-form").style.display = "none";
                        $("admin-games").style.display = "";
                        fetchAdminGames();
                    } else {
                        $("admin-login-form").style.display = "";
                        $("admin-games").style.display = "none";
                        $("admin-status").textContent = "";
                        $("admin-status").className = "";
                        $("admin-user").value = "";
                        $("admin-pass").value = "";
                        $("admin-user").focus();
                    }
                }

                function adminLogin() {
                    const user = $("admin-user").value.trim();
                    const pass = $("admin-pass").value;
                    if (!user || !pass) {
                        $("admin-status").textContent =
                            "‚úó Enter username and password";
                        $("admin-status").className = "err";
                        return;
                    }
                    $("admin-status").textContent = "Authenticating‚Ä¶";
                    $("admin-status").className = "";

                    fetch("/api/admin/login", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            username: user,
                            password: pass,
                        }),
                    })
                        .then((r) =>
                            r.json().then((d) => ({ ok: r.ok, data: d })),
                        )
                        .then(({ ok, data }) => {
                            if (ok) {
                                adminCreds = { username: user, password: pass };
                                adminLoggedIn = true;
                                $("admin-login-form").style.display = "none";
                                $("admin-games").style.display = "";
                                fetchAdminGames();
                                showToast("Admin authenticated", 2000);
                            } else {
                                $("admin-status").textContent =
                                    "‚úó " + (data.error || "Login failed");
                                $("admin-status").className = "err";
                            }
                        })
                        .catch((e) => {
                            $("admin-status").textContent = "‚úó " + e.message;
                            $("admin-status").className = "err";
                        });
                }

                function adminLogout() {
                    adminCreds = { username: null, password: null };
                    adminLoggedIn = false;
                    showLobby();
                    showToast("Logged out", 1500);
                }

                function fetchAdminGames() {
                    const qs =
                        "username=" +
                        encodeURIComponent(adminCreds.username) +
                        "&password=" +
                        encodeURIComponent(adminCreds.password);
                    fetch("/api/admin/games?" + qs)
                        .then((r) => r.json())
                        .then((data) => renderAdminGames(data.games || []))
                        .catch(() => {
                            $("admin-games-list").innerHTML =
                                '<div style="color:var(--red);font-size:12px;">Failed to load games</div>';
                        });
                }

                function renderAdminGames(games) {
                    const list = $("admin-games-list");
                    if (games.length === 0) {
                        list.innerHTML =
                            '<div style="color:var(--text-dim);font-size:12px;">No games found.</div>';
                        return;
                    }
                    list.innerHTML = "";
                    games.forEach((g) => {
                        const row = document.createElement("div");
                        row.className = "admin-game-row";
                        row.innerHTML =
                            '<div><div class="agr-id">' +
                            g.game_id +
                            "</div>" +
                            '<div class="agr-tags">' +
                            (g.tags || []).join(", ") +
                            "</div></div>" +
                            '<button class="agr-delete">DELETE</button>';
                        row.querySelector(".agr-delete").addEventListener(
                            "click",
                            function () {
                                if (
                                    !confirm(
                                        'Delete game "' +
                                            g.game_id +
                                            '"? This cannot be undone.',
                                    )
                                )
                                    return;
                                this.disabled = true;
                                this.textContent = "DELETING‚Ä¶";
                                deleteGame(g.game_id, row);
                            },
                        );
                        list.appendChild(row);
                    });
                }

                function deleteGame(gameId, rowEl) {
                    fetch("/api/admin/games/" + encodeURIComponent(gameId), {
                        method: "DELETE",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            username: adminCreds.username,
                            password: adminCreds.password,
                        }),
                    })
                        .then((r) =>
                            r.json().then((d) => ({ ok: r.ok, data: d })),
                        )
                        .then(({ ok, data }) => {
                            if (ok) {
                                rowEl.remove();
                                showToast("Deleted " + gameId, 2500);
                                fetchAdminGames();
                            } else {
                                showToast(
                                    "Error: " + (data.error || "Delete failed"),
                                    3000,
                                );
                                const btn = rowEl.querySelector(".agr-delete");
                                if (btn) {
                                    btn.disabled = false;
                                    btn.textContent = "DELETE";
                                }
                            }
                        })
                        .catch((e) => {
                            showToast("Error: " + e.message, 3000);
                            const btn = rowEl.querySelector(".agr-delete");
                            if (btn) {
                                btn.disabled = false;
                                btn.textContent = "DELETE";
                            }
                        });
                }

                function showGame() {
                    lobby.classList.add("hidden");
                    gameView.classList.add("show");
                    $("btn-lobby").style.display = "";
                    setupCanvasClick();
                }

                // ‚îÄ‚îÄ Canvas click ‚Üí ACTION6 with display coordinates ‚îÄ‚îÄ
                let canvasClickBound = false;
                function setupCanvasClick() {
                    if (canvasClickBound) return;
                    canvasClickBound = true;

                    function handleCanvasClick(e) {
                        if (!gameState || gameState.state === "WON") return;
                        // Only send click if ACTION6 is available
                        var avail = gameState.available_actions || [];
                        if (avail.indexOf(6) === -1) return;

                        var rect = canvas.getBoundingClientRect();
                        var clickX = e.clientX - rect.left;
                        var clickY = e.clientY - rect.top;

                        // Map canvas pixel ‚Üí game display coordinates
                        var fw = gameState.frame_width || 64;
                        var fh = gameState.frame_height || 64;
                        var displayX = Math.floor((clickX / rect.width) * fw);
                        var displayY = Math.floor((clickY / rect.height) * fh);

                        sendAction("action6", {
                            x: displayX,
                            y: displayY,
                        });
                    }

                    canvas.addEventListener("click", handleCanvasClick);
                    canvas.addEventListener(
                        "touchend",
                        function (e) {
                            if (
                                e.changedTouches &&
                                e.changedTouches.length > 0
                            ) {
                                var touch = e.changedTouches[0];
                                handleCanvasClick({
                                    clientX: touch.clientX,
                                    clientY: touch.clientY,
                                });
                            }
                        },
                        { passive: true },
                    );
                }

                // ‚îÄ‚îÄ Fetch games ‚îÄ‚îÄ
                function fetchGames() {
                    fetch("/api/games")
                        .then((r) => r.json())
                        .then((data) => renderGameList(data.games || []))
                        .catch(() => {
                            gameListEl.innerHTML =
                                '<div class="no-games">Could not load games. Is the server running?</div>';
                        });
                }

                function renderGameList(games) {
                    if (games.length === 0) {
                        gameListEl.innerHTML =
                            '<div class="no-games">No games found in <code>environment_files/</code>.<br>Upload one to get started.</div>';
                        return;
                    }
                    gameListEl.innerHTML = "";
                    games.forEach((g) => {
                        const card = document.createElement("div");
                        card.className = "game-card";
                        card.innerHTML = `
        <div class="gid">${g.game_id}</div>
        <div class="tags">${(g.tags || []).map((t) => `<span class="tag">${t}</span>`).join("")}</div>
        <div class="meta">FPS: ${g.default_fps || "?"} ¬∑ Baseline: [${(g.baseline_actions || []).join(", ")}]</div>
      `;
                        card.addEventListener("click", () =>
                            launchGame(g.game_id),
                        );
                        gameListEl.appendChild(card);
                    });
                }

                // ‚îÄ‚îÄ Upload logic ‚îÄ‚îÄ
                function handleFiles(files) {
                    for (const f of files) {
                        if (f.name.endsWith(".py")) uploadedFiles.py = f;
                        else if (f.name.endsWith(".json"))
                            uploadedFiles.json = f;
                    }
                    renderFileList();
                }

                function renderFileList() {
                    fileListEl.innerHTML = "";
                    if (uploadedFiles.py) {
                        fileListEl.innerHTML += `<div class="file-item"><span class="fname">${uploadedFiles.py.name}</span><span class="fsize">${(uploadedFiles.py.size / 1024).toFixed(1)} KB</span></div>`;
                    }
                    if (uploadedFiles.json) {
                        fileListEl.innerHTML += `<div class="file-item"><span class="fname">${uploadedFiles.json.name}</span><span class="fsize">${(uploadedFiles.json.size / 1024).toFixed(1)} KB</span></div>`;
                    }
                    $("btn-do-upload").disabled = !(
                        uploadedFiles.py && uploadedFiles.json
                    );
                }

                function doUpload() {
                    if (!uploadedFiles.py || !uploadedFiles.json) return;
                    uploadStatus.textContent = "Uploading‚Ä¶";
                    uploadStatus.className = "";

                    const form = new FormData();
                    form.append("game_py", uploadedFiles.py);
                    form.append("metadata", uploadedFiles.json);

                    fetch("/api/upload", { method: "POST", body: form })
                        .then((r) =>
                            r.json().then((d) => ({ ok: r.ok, data: d })),
                        )
                        .then(({ ok, data }) => {
                            if (ok) {
                                uploadStatus.textContent = `‚úì Uploaded ${data.game_id}. Games: ${data.games_available.join(", ")}`;
                                uploadStatus.className = "ok";
                                showToast(
                                    "Game uploaded! Returning to lobby‚Ä¶",
                                    2000,
                                );
                                setTimeout(showLobby, 1500);
                            } else {
                                uploadStatus.textContent = `‚úó ${data.error || "Upload failed"}`;
                                uploadStatus.className = "err";
                            }
                        })
                        .catch((e) => {
                            uploadStatus.textContent = `‚úó ${e.message}`;
                            uploadStatus.className = "err";
                        });
                }

                // ‚îÄ‚îÄ Render frame ‚îÄ‚îÄ
                function renderFrame(base64Png) {
                    if (!base64Png) return;
                    frameImg.onload = function () {
                        const area = $("grid-area");
                        const maxSize = Math.min(
                            area.clientWidth - 32,
                            area.clientHeight - 32,
                        );
                        const size = Math.max(256, Math.min(maxSize, 576));
                        canvas.width = size;
                        canvas.height = size;
                        canvas.style.width = size + "px";
                        canvas.style.height = size + "px";
                        ctx.imageSmoothingEnabled = false;
                        ctx.drawImage(frameImg, 0, 0, size, size);

                        // Subtle grid overlay ‚Äî adapt to frame dimensions
                        var fw = (gameState && gameState.frame_width) || 8;
                        var fh = (gameState && gameState.frame_height) || 8;
                        var cellW = size / fw;
                        var cellH = size / fh;
                        ctx.strokeStyle = "rgba(255,255,255,0.06)";
                        ctx.lineWidth = 1;
                        for (let i = 1; i < fw; i++) {
                            ctx.beginPath();
                            ctx.moveTo(i * cellW, 0);
                            ctx.lineTo(i * cellW, size);
                            ctx.stroke();
                        }
                        for (let i = 1; i < fh; i++) {
                            ctx.beginPath();
                            ctx.moveTo(0, i * cellH);
                            ctx.lineTo(size, i * cellH);
                            ctx.stroke();
                        }
                    };
                    frameImg.src = "data:image/png;base64," + base64Png;
                }

                // ‚îÄ‚îÄ Update UI ‚îÄ‚îÄ
                const ACTION_NAMES = {
                    1: "‚Üë UP",
                    2: "‚Üì DOWN",
                    3: "‚Üê LEFT",
                    4: "‚Üí RIGHT",
                    5: "‚èé ACTIVATE",
                    6: "üñ± CLICK",
                    7: "‚Ü∂ UNDO",
                    0: "‚ü≥ RESET",
                };

                function updateUI(state) {
                    if (!state) return;
                    gameState = state;

                    sbGameId.textContent = state.game_id || "‚Äî";

                    if (state.state === "WON") {
                        sbState.textContent = "‚òÖ VICTORY";
                        sbState.className = "won";
                    } else if (state.state && state.state.includes("LOST")) {
                        sbState.textContent = "‚úó GAME OVER";
                        sbState.className = "lost";
                    } else {
                        sbState.textContent = "‚ñ∂ PLAYING";
                        sbState.className = "playing";
                    }

                    // Progress
                    const total = state.total_levels || 0;
                    const done = state.levels_completed || 0;
                    progressBar.innerHTML = "";
                    if (total > 0) {
                        for (let i = 0; i < total; i++) {
                            const seg = document.createElement("div");
                            seg.className =
                                "progress-seg" + (i < done ? " filled" : "");
                            progressBar.appendChild(seg);
                        }
                    }

                    sbActions.textContent =
                        "ACTIONS: " + (state.total_actions || 0);
                    sbSession.textContent = state.session_id || "‚Äî";

                    // Available actions
                    availList.innerHTML = "";
                    if (state.available_actions) {
                        [...state.available_actions]
                            .sort((a, b) => a - b)
                            .forEach((a) => {
                                const el = document.createElement("div");
                                el.className = "avail-item";
                                el.textContent = ACTION_NAMES[a] || "ACT" + a;
                                availList.appendChild(el);
                            });
                    }

                    if (state.frame) renderFrame(state.frame);
                }

                // ‚îÄ‚îÄ Socket ‚îÄ‚îÄ
                function connectSocket() {
                    if (socket) return;

                    socket = io({
                        transports: ["websocket", "polling"],
                        reconnectionAttempts: 10,
                        reconnectionDelay: 1000,
                    });

                    socket.on("connect", () => {
                        connStatus.textContent = "‚óè CONNECTED";
                        connStatus.className = "status connected";
                        if (sessionId) {
                            socket.emit("join_game", { session_id: sessionId });
                        }
                    });

                    socket.on("disconnect", () => {
                        connStatus.textContent = "‚óè DISCONNECTED";
                        connStatus.className = "status disconnected";
                    });

                    socket.on("connect_error", () => {
                        connStatus.textContent = "‚óè ERROR";
                        connStatus.className = "status disconnected";
                    });

                    socket.on("game_created", (state) => {
                        sessionId = state.session_id;
                        prevLevels = 0;
                        localStorage.setItem("arc_session", sessionId);
                        showGame();
                        updateUI(state);
                        showToast("Game started");
                    });

                    socket.on("game_joined", (state) => {
                        sessionId = state.session_id;
                        prevLevels = state.levels_completed || 0;
                        showGame();
                        updateUI(state);
                        showToast("Reconnected");
                    });

                    socket.on("frame_update", (state) => {
                        const newLvl = state.levels_completed || 0;
                        if (
                            newLvl > prevLevels &&
                            newLvl < (state.total_levels || 999)
                        ) {
                            showToast("LEVEL " + newLvl + " COMPLETE!", 2000);
                        }
                        prevLevels = newLvl;
                        updateUI(state);
                    });

                    socket.on("level_complete", (data) => {
                        showToast("LEVEL " + data.level + " COMPLETE!", 2000);
                    });

                    socket.on("game_won", (data) => {
                        victoryStats.innerHTML =
                            "Total actions: " +
                            (data.total_actions || 0) +
                            '<br><br><span style="font-size:12px;color:var(--text-dim);">Scorecard</span><br>' +
                            '<span style="font-size:12px;color:var(--cyan);">' +
                            (data.scorecard || "N/A") +
                            "</span>";
                        victoryOverlay.classList.add("show");
                    });

                    socket.on("game_restarted", (state) => {
                        victoryOverlay.classList.remove("show");
                        prevLevels = 0;
                        updateUI(state);
                        showToast("Restarted");
                    });

                    socket.on("level_reset", (state) => {
                        updateUI(state);
                        showToast("Level reset");
                    });

                    socket.on("error", (data) => {
                        showToast("Error: " + (data.message || "?"), 4000);
                    });
                }

                // ‚îÄ‚îÄ Actions ‚îÄ‚îÄ
                function sendAction(action, actionData) {
                    if (!socket || !sessionId) return;
                    if (gameState && gameState.state === "WON") return;
                    var payload = {
                        session_id: sessionId,
                        action: action,
                    };
                    if (actionData !== undefined) {
                        payload.data = actionData;
                    }
                    socket.emit("action", payload);
                }
                function sendRestart() {
                    if (!socket || !sessionId) return;
                    socket.emit("restart", { session_id: sessionId });
                }
                function sendResetLevel() {
                    if (!socket || !sessionId) return;
                    socket.emit("reset_level", { session_id: sessionId });
                }

                function startGame() {
                    if (!selectedGameId) return;
                    const name = "PLAYER 1";
                    const seed = 0;

                    connectSocket();

                    // Wait for connection then create
                    let tries = 0;
                    const iv = setInterval(() => {
                        tries++;
                        if (socket && socket.connected) {
                            clearInterval(iv);
                            socket.emit("create_game", {
                                game_id: selectedGameId,
                                seed: seed,
                                player_name: name,
                            });
                        }
                        if (tries > 50) {
                            clearInterval(iv);
                            showToast("Connection failed", 3000);
                        }
                    }, 100);
                }

                // ‚îÄ‚îÄ Keyboard ‚îÄ‚îÄ
                document.addEventListener("keydown", (e) => {
                    if (e.target.tagName === "INPUT") return;
                    // Only handle keys when game view is visible
                    if (!gameView.classList.contains("show")) return;

                    const ctrl = e.ctrlKey || e.metaKey;

                    if (ctrl && e.key === "r") {
                        e.preventDefault();
                        sendRestart();
                        return;
                    }
                    if (ctrl && e.key === "z") {
                        e.preventDefault();
                        sendAction("undo");
                        return;
                    }

                    switch (e.key) {
                        case "w":
                        case "W":
                        case "ArrowUp":
                            e.preventDefault();
                            sendAction("up");
                            break;
                        case "s":
                        case "S":
                        case "ArrowDown":
                            e.preventDefault();
                            sendAction("down");
                            break;
                        case "a":
                        case "A":
                        case "ArrowLeft":
                            e.preventDefault();
                            sendAction("left");
                            break;
                        case "d":
                        case "D":
                        case "ArrowRight":
                            e.preventDefault();
                            sendAction("right");
                            break;
                        case " ":
                        case "Enter":
                            e.preventDefault();
                            sendAction("action5");
                            break;
                        case "e":
                        case "E":
                            e.preventDefault();
                            sendAction("action6");
                            break;
                        case "r":
                        case "R":
                            sendResetLevel();
                            break;
                    }
                });

                // Prevent arrow key scrolling
                window.addEventListener("keydown", (e) => {
                    if (
                        [
                            "ArrowUp",
                            "ArrowDown",
                            "ArrowLeft",
                            "ArrowRight",
                            " ",
                        ].includes(e.key) &&
                        e.target.tagName !== "INPUT"
                    ) {
                        e.preventDefault();
                    }
                });

                // ‚îÄ‚îÄ Button wiring ‚îÄ‚îÄ
                $("btn-lobby").addEventListener("click", () => {
                    sessionId = null;
                    showLobby();
                });
                $("btn-upload").addEventListener("click", showUpload);
                $("btn-logo").addEventListener("click", () => {
                    sessionId = null;
                    showLobby();
                });
                window.addEventListener("popstate", () => {
                    var path = window.location.pathname;
                    var match = path.match(/^\/game\/(.+)$/);
                    if (match) {
                        selectedGameId = decodeURIComponent(match[1]);
                        startGame();
                    } else {
                        sessionId = null;
                        showLobby();
                    }
                });
                $("btn-admin").addEventListener("click", showAdmin);
                $("btn-admin-login").addEventListener("click", adminLogin);
                $("btn-admin-back").addEventListener("click", showLobby);
                $("btn-admin-logout").addEventListener("click", adminLogout);
                $("admin-pass").addEventListener("keydown", (e) => {
                    if (e.key === "Enter") adminLogin();
                });
                $("admin-user").addEventListener("keydown", (e) => {
                    if (e.key === "Enter") $("admin-pass").focus();
                });
                $("btn-upload-back").addEventListener("click", showLobby);
                $("btn-do-upload").addEventListener("click", doUpload);
                $("btn-restart").addEventListener("click", sendRestart);
                $("btn-back-lobby").addEventListener("click", () => {
                    sessionId = null;
                    showLobby();
                });
                $("btn-play-again").addEventListener("click", sendRestart);
                $("btn-victory-lobby").addEventListener("click", () => {
                    victoryOverlay.classList.remove("show");
                    sessionId = null;
                    showLobby();
                });

                // ‚îÄ‚îÄ Mobile controls ‚îÄ‚îÄ
                document.querySelectorAll("[data-action]").forEach((btn) => {
                    function handler(e) {
                        e.preventDefault();
                        sendAction(btn.getAttribute("data-action"));
                    }
                    btn.addEventListener("click", handler);
                    btn.addEventListener("touchstart", handler, {
                        passive: false,
                    });
                });

                // ‚îÄ‚îÄ File upload drag & drop ‚îÄ‚îÄ
                dropZone.addEventListener("click", () => fileInput.click());
                fileInput.addEventListener("change", () =>
                    handleFiles(fileInput.files),
                );
                dropZone.addEventListener("dragover", (e) => {
                    e.preventDefault();
                    dropZone.classList.add("dragover");
                });
                dropZone.addEventListener("dragleave", () =>
                    dropZone.classList.remove("dragover"),
                );
                dropZone.addEventListener("drop", (e) => {
                    e.preventDefault();
                    dropZone.classList.remove("dragover");
                    handleFiles(e.dataTransfer.files);
                });

                // ‚îÄ‚îÄ Resize ‚îÄ‚îÄ
                window.addEventListener("resize", () => {
                    if (gameState && gameState.frame)
                        renderFrame(gameState.frame);
                });

                // ‚îÄ‚îÄ Init ‚îÄ‚îÄ
                connectSocket();

                // Check URL for direct game link: /game/<game_id>
                (function checkRoute() {
                    var path = window.location.pathname;
                    var match = path.match(/^\/game\/(.+)$/);
                    if (match) {
                        selectedGameId = decodeURIComponent(match[1]);
                        startGame();
                    } else {
                        fetchGames();
                    }
                })();
            })();
        </script>
    </body>
</html>
